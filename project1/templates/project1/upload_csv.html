{% extends 'base.html' %}

{% load static %}

{% block extra_css %}
  <style>
    /* 1) Make sure html/body aren’t blocking scrolling: */
    html, body {
      height: auto !important;
      overflow-y: auto !important;
      margin: 0;
      padding: 0;
    }

    /* 2) Let your main “.box” grow beyond the viewport and scroll if needed: */
    .box {
      max-height: 100vh;       /* never taller than the viewport */
      overflow-y: auto;        /* show a scrollbar when it’s too tall */
      padding: 20px;
      box-sizing: border-box;
      margin: 0 auto;
    }
  </style>
{% endblock %}

{% block content %}
<div class="box">
    <div class="title-container" style="margin-top: 20px;">
        <div class="title">Upload and Visualize CSV</div>
    </div>

    <div class="main-text">
        {% if csv_data %}
        <p class="centered-text">
            Upload another CSV file to visualize different data. The CSV should be structured with the first row 
            containing feature names, and the last column containing the output values.
        </p>
        {% else %}
        <p class="centered-text">
            Upload a CSV file to visualize the data. The CSV should be structured with the first row 
            containing feature names, and the last column containing the output values.
        </p>
        {% endif %}
        
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit">Upload and Visualize</button>
        </form>
        
        {% if error %}
            <p style="color: red;">{{ error }}</p>
        {% endif %}
        
        {% if csv_data %}
            <h3>CSV Data Preview of "{{ filename }}"</h3>
            <p><em>Showing all {{ row_count }} rows</em></p>
            
            <div style="max-height: 300px; overflow-y: auto; overflow-x: auto; margin-bottom: 20px; border: 1px solid #ddd;">
                <table border="1" style="width: 100%; border-collapse: collapse;">
                    <thead style="position: sticky; top: 0; background-color: #f9f9f9;">
                        <tr>
                            {% for column in headers %}
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd;">{{ column }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in data %}
                            <tr>
                                {% for cell in row %}
                                    <td style="padding: 8px; border-bottom: 1px solid #ddd;">{{ cell }}</td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Interactive Visualization Section -->
            <div style="margin-top: 30px; padding: 20px; background-color: #f9f9f9; border-radius: 10px;">
                <h3>Interactive Visualization</h3>
                
                <div style="margin-bottom: 20px;">
                    <label><input type="radio" name="analysis-type" value="classification" checked> Classification</label>
                </div>
                
                <div id="feature-selection" style="margin-bottom: 20px;">
                    <p><strong>Select features to plot:</strong></p>
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <div>
                            <label for="x-feature">X-axis feature:</label>
                            <select id="x-feature" class="feature-select">
                                {% for feature in features %}
                                    <option value="{{ forloop.counter0 }}">{{ feature }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="y-feature">Y-axis feature:</label>
                            <select id="y-feature" class="feature-select">
                                {% for feature in features %}
                                    {% if forloop.counter0 == 1 %}
                                        <option value="{{ forloop.counter0 }}" selected>{{ feature }}</option>
                                    {% else %}
                                        <option value="{{ forloop.counter0 }}">{{ feature }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                
                <div style="width: 100%; height: 400px;">
                    <canvas id="scatterChart"></canvas>
                </div>
            </div>
        {% endif %}
        
        {% if plots %}
            <h3>Data Visualization</h3>
            <div class="visualization-container">
                {% for plot in plots %}
                    <img src="data:image/png;base64,{{ plot }}" alt="Data Visualization" style="max-width: 100%; margin-bottom: 20px;">
                {% endfor %}
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block script %}
{% if csv_data %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // JSON data from backend
    const features = {{ features_json|safe }};
    const dataPoints = {{ data_json|safe }};
    const targetClasses = {{ target_classes|safe }};
    const uniqueClasses = {{ unique_classes|safe }};
    const colorPalette = [
        'rgba(255, 99, 132, 0.7)',
        'rgba(54, 162, 235, 0.7)',
        'rgba(255, 206, 86, 0.7)',
        'rgba(75, 192, 192, 0.7)',
        'rgba(153, 102, 255, 0.7)',
        'rgba(255, 159, 64, 0.7)',
        'rgba(199, 199, 199, 0.7)',
        'rgba(83, 102, 255, 0.7)',
        'rgba(40, 159, 64, 0.7)',
        'rgba(210, 199, 199, 0.7)'
    ];
    
    let chart;
    
    function createChart(xFeatureIndex, yFeatureIndex) {
        const ctx = document.getElementById('scatterChart').getContext('2d');
        
        // Group data by class
        const datasets = [];
        
        for (let i = 0; i < uniqueClasses.length; i++) {
            const classValue = uniqueClasses[i];
            const points = [];
            
            for (let j = 0; j < dataPoints.length; j++) {
                if (targetClasses[j] === classValue) {
                    points.push({
                        x: dataPoints[j][xFeatureIndex],
                        y: dataPoints[j][yFeatureIndex]
                    });
                }
            }
            
            datasets.push({
                label: `Class ${classValue}`,
                data: points,
                backgroundColor: colorPalette[i % colorPalette.length],
                borderColor: colorPalette[i % colorPalette.length].replace('0.7', '1'),
                borderWidth: 1,
                pointRadius: 5,
                pointHoverRadius: 7
            });
        }
        
        // Destroy previous chart if it exists
        if (chart) {
            chart.destroy();
        }
        
        // Create new chart
        chart = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: features[xFeatureIndex]
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: features[yFeatureIndex]
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Classification Visualization',
                        font: {
                            size: 16
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: (${context.parsed.x.toFixed(2)}, ${context.parsed.y.toFixed(2)})`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Event listeners for feature selection
    document.getElementById('x-feature').addEventListener('change', updateChart);
    document.getElementById('y-feature').addEventListener('change', updateChart);
    
    function updateChart() {
        const xFeatureIndex = parseInt(document.getElementById('x-feature').value);
        const yFeatureIndex = parseInt(document.getElementById('y-feature').value);
        createChart(xFeatureIndex, yFeatureIndex);
    }
    
    // Initialize chart with default features
    document.addEventListener('DOMContentLoaded', function() {
        updateChart();
    });
</script>
{% endif %}
{% endblock script %} 